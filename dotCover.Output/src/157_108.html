<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Akanksha Wattamwar\Desktop\CS455\CS455-Assignment-1\src\Pages\Game.razor</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
@page &quot;/&quot;
@inject IJSRuntime JSRuntime
@inject HttpClient Http

&lt;PageTitle&gt;Whack&#39;Em-All&lt;/PageTitle&gt;

@if (isGameStarted)
{
    &lt;div class=&quot;game-container&quot;&gt;
        &lt;h3&gt;Welcome to Whack&#39;Em-All&lt;/h3&gt;

        &lt;div class=&quot;info-container&quot;&gt;
            &lt;h2&gt;Score: @score&lt;/h2&gt;
            &lt;h2&gt;Remaining Time: @currentTime&lt;/h2&gt;
        &lt;/div&gt;

        &lt;div class=&quot;canvas&quot;&gt;
            @foreach (var s in Cells)
            {
                &lt;Cell CellModel=&quot;s&quot; OnMouseUp=&quot;() =&gt; MouseUp(s)&quot; /&gt;
            }
        &lt;/div&gt;

        &lt;audio id=&quot;hitSound&quot; src=&quot;hitsound.mp3&quot; preload=&quot;auto&quot;&gt;&lt;/audio&gt;
        &lt;audio id=&quot;missSound&quot; src=&quot;misssound.mp3&quot; preload=&quot;auto&quot;&gt;&lt;/audio&gt;
    &lt;/div&gt;
}
else if (showLeaderboard)
{
    &lt;div class=&quot;leaderboard-page&quot;&gt;
        &lt;h1&gt;Leaderboard&lt;/h1&gt;
        &lt;table&gt;
            &lt;thead&gt;
                &lt;tr&gt;
                    &lt;th&gt;Rank&lt;/th&gt;
                    &lt;th&gt;Name&lt;/th&gt;
                    &lt;th&gt;Score&lt;/th&gt;
                &lt;/tr&gt;
            &lt;/thead&gt;
            &lt;tbody&gt;
                @for (int i = 0; i &lt; leaderboardData.Count; i++)
                {
                    &lt;tr&gt;
                        &lt;td&gt;@(i + 1)&lt;/td&gt;
                        &lt;td&gt;@leaderboardData[i].Name&lt;/td&gt;
                        &lt;td&gt;@leaderboardData[i].Score&lt;/td&gt;
                    &lt;/tr&gt;
                }
            &lt;/tbody&gt;
        &lt;/table&gt;
        &lt;button @onclick=&quot;CloseLeaderboard&quot;&gt;Back to Menu&lt;/button&gt;
    &lt;/div&gt;
}
else
{
    &lt;div class=&quot;start-menu&quot;&gt;
        &lt;h1&gt;Welcome to Whack&#39;Em-All!&lt;/h1&gt;
        &lt;div class=&quot;Instructions&quot;&gt;
            &lt;p&gt; How to play?? &lt;/p&gt;
            &lt;ul&gt;
                &lt;li&gt;The game consists of a 4x4 grid. Every second, a smiley will appear in one of the grid cells.&lt;/li&gt;
                &lt;li&gt;You need to collect these smileys by clicking on them.&lt;/li&gt;
                &lt;li&gt;Each time you collect one, your score will increase by one.&lt;/li&gt;
                &lt;li&gt;You have 60 seconds to play. The game will end after that.&lt;/li&gt;
            &lt;/ul&gt;
            &lt;p&gt;ALL THE BEST!!!&lt;/p&gt;
        &lt;/div&gt;

        @* &lt;p&gt;Are you ready to start the game?&lt;/p&gt; *@
        &lt;div class=&quot;Buttons&quot;&gt;
        &lt;button @onclick=&quot;ShowNamePrompt&quot;&gt;Start Game&lt;/button&gt;
        &lt;button @onclick=&quot;ViewLeaderboard&quot;&gt;View Leaderboard&lt;/button&gt;
        &lt;/div&gt;
    &lt;/div&gt;
}

@if (showNamePrompt)
{
    &lt;div class=&quot;modal-overlay&quot;&gt;
        &lt;div class=&quot;modal-content&quot;&gt;
            &lt;h1&gt;Enter Your Name&lt;/h1&gt;
            &lt;input type=&quot;text&quot; @bind=&quot;playerName&quot; placeholder=&quot;Name&quot; /&gt;
             @* //&lt;p&gt;Current Player Name: @playerName&lt;/p&gt; &lt;!-- Debug line --&gt; *@
            &lt;button @onclick=&quot;StartGame&quot;&gt;Start Game&lt;/button&gt;
            &lt;button @onclick=&quot;CancelNamePrompt&quot;&gt;Cancel&lt;/button&gt;
        &lt;/div&gt;
    &lt;/div&gt;
}

@if (showGameOverModal)
{
    &lt;div class=&quot;modal-overlay&quot;&gt;
        &lt;div class=&quot;modal-content&quot;&gt;
            @if (score &lt; 45)
            {
                &lt;h2&gt;Oops ... Game Over!&lt;/h2&gt;
                &lt;p&gt;Your final score is: @score&lt;/p&gt;
            }
            else
            {
                &lt;h2&gt;You Won!&lt;/h2&gt;
                &lt;p&gt;Your final score is: @score&lt;/p&gt;
            }
            &lt;button @onclick=&quot;RestartGame&quot;&gt;Restart Game&lt;/button&gt;
            &lt;button @onclick=&quot;ReturnToStartMenu&quot;&gt;Return to Start Menu&lt;/button&gt;
            &lt;button @onclick=&quot;ViewLeaderboard&quot;&gt;View Leaderboard&lt;/button&gt;
        &lt;/div&gt;
    &lt;/div&gt;
}

@code {
    private Random random = new Random();
    public List&lt;LeaderboardEntry&gt; leaderboardData = new List&lt;LeaderboardEntry&gt;();
    public async Task ViewLeaderboard()
    {
        try
        {   
            showGameOverModal = false;
            isGameStarted = false;
            var response = await Http.GetFromJsonAsync&lt;List&lt;LeaderboardEntry&gt;&gt;(&quot;https://cs455-assignment-1.onrender.com/leaderboard&quot;);
            Console.WriteLine(response);
            if (response != null)
            {
                leaderboardData = response;
                showLeaderboard = true;
            }
            else
            {
                Console.WriteLine(&quot;Failed to fetch leaderboard data.&quot;);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($&quot;Error fetching leaderboard: {ex.Message}&quot;);
        }
    }

    public void CloseLeaderboard()
    {
        showLeaderboard = false;
    }

    public void ShowNamePrompt()
    {
        showNamePrompt = true;
    }

    public void CancelNamePrompt()
    {
        showNamePrompt = false;
        playerName = string.Empty;
    }

    public async Task MouseUp(CellModel s)
    {
        if (isGameRunning)
        {
            if (s.Id == hitPosition)
            {
                score += 1;
                await PlayHitSound();
            }
            else
            {
                await PlayMissSound();
            }
        }
    }

    protected async Task PlayHitSound()
    {
        await JSRuntime.InvokeVoidAsync(&quot;playSound1&quot;);
    }

    protected async Task PlayMissSound()
    {
        await JSRuntime.InvokeVoidAsync(&quot;playSound2&quot;);
    }

    public void setNextAppearance()
    {
        foreach (var item in Cells)
        {
            item.IsShown = false;
        }

        int randomPosition;
        do
        {
            randomPosition = random.Next(0, 16);
        } while (lastPosition == randomPosition);

        Cells[randomPosition].IsShown = true;
        hitPosition = randomPosition;
        lastPosition = randomPosition;
    }

    protected virtual async Task GameLoopAsync(PeriodicTimer timer)
    {
        while (isGameRunning)
        {
            setNextAppearance();
            StateHasChanged();
            await timer.WaitForNextTickAsync();
            StateHasChanged();
        }
    }

    protected virtual async Task GameTimeAsync(PeriodicTimer timer)
    {
        while (isGameRunning)
        {
            if (currentTime == 0)
            {
                await EndGame();
                break;
            }
            await timer.WaitForNextTickAsync();
            currentTime--;
            StateHasChanged();
        }
    }

    public void StartGame()
    {
        if (string.IsNullOrWhiteSpace(playerName))
        {
            Console.WriteLine(&quot;Please enter a valid name.&quot;);
            return;
        }
        showNamePrompt = false;
        isGameStarted = true;
        score = 0;
        currentTime = 60;
        isGameRunning = true;
        showGameOverModal = false;

        gameLoopTimer = new PeriodicTimer(TimeSpan.FromMilliseconds(1000)); 
        _ = GameLoopAsync(gameLoopTimer);

        gameTimeTimer = new PeriodicTimer(TimeSpan.FromSeconds(1));
        _ = GameTimeAsync(gameTimeTimer);
    }

    public async Task EndGame()
    {
        isGameRunning = false;
        showGameOverModal = true;
        gameLoopTimer?.Dispose();
        gameTimeTimer?.Dispose();
        
        await SendScoreToServer(score); 
    }

    public void RestartGame()
    {
        showGameOverModal = false;
        StartGame();
    }

    public void ReturnToStartMenu()
    {
        showGameOverModal = false;
        isGameStarted = false;
    }

    public virtual async Task SendScoreToServer(int score)
    {
        var response = await Http.PostAsJsonAsync(&quot;https://cs455-assignment-1.onrender.com/&quot;, new { name = playerName, score });
        if (response.IsSuccessStatusCode)
        {
            Console.WriteLine(&quot;Score successfully sent to the server.&quot;);
        }
        else
        {
            Console.WriteLine($&quot;Failed to send score. Status Code: {response.StatusCode}&quot;);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[7,2,7,20,1],[8,1,8,2,0],[18,14,18,21,0],[18,23,18,28,0],[18,29,18,31,0],[18,32,18,37,0],[19,13,19,14,0],[20,54,20,64,0],[21,13,21,14,0],[27,1,27,2,0],[28,6,28,26,1],[29,1,29,2,0],[41,23,41,32,0],[41,34,41,59,0],[41,61,41,64,0],[42,17,42,18,0],[48,17,48,18,0],[53,1,53,2,0],[55,1,55,2,1],[75,1,75,2,1],[77,2,77,21,1],[78,1,78,2,0],[88,1,88,2,1],[90,2,90,24,1],[91,1,91,2,0],[94,14,94,29,0],[95,13,95,14,0],[98,13,98,14,0],[100,13,100,14,0],[103,13,103,14,0],[109,1,109,2,1],[112,5,112,42,1],[113,5,113,82,1],[115,5,115,6,1],[117,9,117,10,1],[118,13,118,39,1],[119,13,119,35,1],[120,13,120,135,1],[121,13,121,41,1],[122,13,122,34,1],[123,13,123,14,1],[124,17,124,44,1],[125,17,125,40,1],[126,13,126,14,1],[128,13,128,14,0],[129,17,129,72,0],[130,13,130,14,1],[131,9,131,10,1],[132,9,132,29,1],[133,9,133,10,1],[134,13,134,76,1],[135,9,135,10,1],[136,5,136,6,1],[139,5,139,6,1],[140,9,140,33,1],[141,5,141,6,1],[144,5,144,6,1],[145,9,145,31,1],[146,5,146,6,1],[149,5,149,6,1],[150,9,150,32,1],[151,9,151,35,1],[152,5,152,6,1],[155,5,155,6,1],[156,9,156,27,1],[157,9,157,10,1],[158,13,158,37,1],[159,13,159,14,1],[160,17,160,28,1],[161,17,161,38,1],[162,13,162,14,1],[164,13,164,14,1],[165,17,165,39,1],[166,13,166,14,1],[167,9,167,10,1],[168,5,168,6,1],[171,5,171,6,1],[172,9,172,55,1],[173,5,173,6,1],[176,5,176,6,1],[177,9,177,55,1],[178,5,178,6,1],[181,5,181,6,1],[182,9,182,16,1],[182,18,182,26,1],[182,27,182,29,1],[182,30,182,35,1],[183,9,183,10,1],[184,13,184,34,1],[185,9,185,10,1],[189,9,189,10,1],[190,13,190,49,1],[191,9,191,10,1],[191,11,191,50,1],[193,9,193,46,1],[194,9,194,38,1],[195,9,195,39,1],[196,5,196,6,1],[199,5,199,6,1],[200,9,200,30,1],[201,9,201,10,1],[202,13,202,33,1],[203,13,203,31,1],[204,13,204,48,0],[205,13,205,31,0],[206,9,206,10,1],[207,5,207,6,0],[210,5,210,6,1],[211,9,211,30,1],[212,9,212,10,1],[213,13,213,34,1],[214,13,214,14,0],[215,17,215,33,0],[216,17,216,23,1],[218,13,218,48,1],[219,13,219,27,1],[220,13,220,31,1],[221,9,221,10,1],[222,5,222,6,0],[225,5,225,6,1],[226,9,226,51,1],[227,9,227,10,1],[228,13,228,61,1],[229,13,229,20,1],[231,9,231,32,1],[232,9,232,30,1],[233,9,233,19,1],[234,9,234,26,1],[235,9,235,30,1],[236,9,236,35,1],[238,9,238,76,1],[239,9,239,42,1],[241,9,241,68,1],[242,9,242,42,1],[243,5,243,6,1],[246,5,246,6,1],[247,9,247,31,1],[248,9,248,34,1],[249,9,249,34,1],[250,9,250,34,1],[252,9,252,40,1],[253,5,253,6,1],[256,5,256,6,1],[257,9,257,35,1],[258,9,258,21,1],[259,5,259,6,1],[262,5,262,6,1],[263,9,263,35,1],[264,9,264,31,1],[265,5,265,6,1],[268,5,268,6,1],[269,9,269,129,1],[270,9,270,42,1],[271,9,271,10,1],[272,13,272,73,1],[273,9,273,10,1],[275,9,275,10,0],[276,13,276,92,0],[277,9,277,10,0],[278,5,278,6,1]]);
    </script>
  </body>
</html>